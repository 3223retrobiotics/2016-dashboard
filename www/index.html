<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">

        <link rel="stylesheet" type="text/css" href="css/bootstrap.css">
        <link rel="stylesheet" type="text/css" href="css/c3.css">
</head>
<body>

<script src="/js/d3.js" type="text/javascript"></script>
<script src="/js/c3.js" type="text/javascript"></script>
<script src="/js/networktables.js" type="text/javascript"></script>
<!--
<script src="/js/utils.js" type="text/javascript"></script>
-->

<script src="/js/jquery-2.1.3.min.js" type="text/javascript"></script>
<script src="/js/bootstrap.js" type="text/javascript"></script>
<script src="/js/stuff.js" type="text/javascript"></script>

<div id='Main'>
    <ul id='tabs' class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active">
            <a href="#teleop">Teleop</a>
        </li>
        <li role="presentation">
            <a href="#auto">Auto</a>
        </li>
        <li role="presentation">
            <a href="#other">Scratch space</a>
        </li>
    </ul>
    <div id="Content" class="tab-content">
        <div role="tabpanel" class="tab-pane active" id="teleop">
            Teleop!
        </div>
        <div role="tabpanel" class="tab-pane" id="auto">
            Auto!
        </div>
        <div role="tabpanel" class="tab-pane" id="other">
            <div>
                NetworkTables websocket: <span id="connectstate">Unknown state</span><br/>
                Robot: <span id="robotstate">Unknown state</span>
            </div>
            <hr/>

            <table id="nt" border=1>
                <tbody></tbody>
            </table>

            <div id="chart">
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
"use strict";
var chart;
var data = ['y'];
var maxSize = 10;

$(document).ready(function(){
	console.info("hell otaco!");
        setInterval(chartRefresh, 200);
	// sets a function that will be called when the websocket connects/disconnects
	NetworkTables.addWsConnectionListener(onNetworkTablesConnection, true);
	
	// sets a function that will be called when the robot connects/disconnects
	NetworkTables.addRobotConnectionListener(onRobotConnection, true);
	
	// sets a function that will be called when any NetworkTables key/value changes
	NetworkTables.addGlobalListener(onValueChanged, true);

	chart = c3.generate({
		data: {
        columns: [
            data
        ]
    }
	});
});


function onRobotConnection(connected) {
	$('#robotstate').text(connected ? "Connected!" : "Disconnected");
}

function onNetworkTablesConnection(connected) {

	if (connected) {
		$("#connectstate").text("Connected!");
		
		// clear the table
		$("#nt tbody > tr").remove();
		
	} else {
		$("#connectstate").text("Disconnected!");
	}
}

function chartRefresh() {
    chart.load ({
        columns:[data]
    });
}

function onValueChanged(key, value, isNew) {

	// key thing here: we're using the various NetworkTable keys as
	// the id of the elements that we're appending, for simplicity. However,
	// the key names aren't always valid HTML identifiers, so we use
	// the NetworkTables.keyToId() function to convert them appropriately

	if (isNew) {
		var tr = $('<tr></tr>').appendTo($('#nt > tbody:last'));
		$('<td></td>').text(key).appendTo(tr);
		$('<td></td>').attr('id', NetworkTables.keyToId(key))
					   .text(value)
					   .appendTo(tr);

		
	} else {
	
		// similarly, use keySelector to convert the key to a valid jQuery
		// selector. This should work for class names also, not just for ids
		$('#' + NetworkTables.keySelector(key)).text(value);

            if (key=== "/SmartDashboard/theta"){
                var c = data.shift();
                data.unshift(value);
                data.unshift(c);
                if (data.length >= maxSize){			
                        data.pop();
                }
                if(data.length % 100 === 0) {
                        //console.info("data: ", data);
                }
            }
	}
}

</script>

</body>
</html>
